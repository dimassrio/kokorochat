!function(){window.PHONE=function(a){function b(b){var e=z[b]||function(b){var e={number:b,status:"",image:document.createElement("img"),started:+new Date,imgset:!1,imgsent:0,pc:new B(E),closed:!1,usermsg:function(){},thumb:null,connect:function(){},end:function(){}};return e.pc.onaddstream=a.onaddstream||f,e.pc.onicecandidate=g,e.pc.number=b,e.hangup=function(a){e.closed||(e.closed=!0,e.imgset=!1,clearInterval(e.snapi),a!==!1&&k(b,{hangup:!0}),e.end(e),e.pc.close(),c(b))},e.send=function(a){k(b,{usermsg:a})},e.snap=function(){var a=s();e.closed&&clearInterval(e.snapi),k(b,{thumbnail:a});var c=document.createElement("img");return c.src=a,{data:a,image:c}},e.snapi=setInterval(function(){return e.imgsent++>5?clearInterval(e.snapi):void e.snap()},1500),e.snap(),e.thumbnail=function(a){return e.thumb=a,e},e.ended=function(a){return e.end=a,e},e.connected=function(a){return e.connect=a,e},e.message=function(a){return e.usermsg=a,e},e.pc.addStream(v),d(e,"connecting"),z[b]=e,e}(b);return e}function c(a){z[a]=null,delete z[a]}function d(a,b){return a.status=b,M(a),a}function e(a){var b=w,c=document.createElement("canvas"),d=c.getContext("2d"),e={width:240,height:180};b.width=e.width,b.height=e.height,b.src=URL.createObjectURL(a),b.volume=0,b.play(),c.width=e.width,c.height=e.height,s=function(){try{d.drawImage(b,0,0,e.width,e.height)}catch(a){}return c.toDataURL("image/jpeg",.3)},p.video=b}function f(a){var c=document.createElement("video"),d=a.stream,e=(a.srcElement||a.target).number,f=b(e);c.setAttribute("autoplay","autoplay"),c.src=URL.createObjectURL(d),f.video=c,f.connect(f)}function g(a){a.candidate&&k(this.number,a.candidate)}function h(){q.subscribe({restore:!0,channel:a.number,message:l,disconnect:K,reconnect:L,connect:function(){i(!0)}})}function i(a){a&&(x=!0),v&&x&&(J(),G())}function j(){navigator.getUserMedia(y,function(a){return a?(v=a,e(a),i(),void h()):H(a)},function(a){return I(a),H(a)})}function k(b,c,d,e){if(c){var f=a.number,g={packet:c,id:u,number:f};I(g),q.publish({channel:b,message:g}),d&&(e=e||1,e++>=d||setTimeout(function(){k(b,c,d,e)},150))}}function l(a){I(a);var c=b(a.number);if(!c.closed){if(a.packet.usermsg)return F(c,a.packet.usermsg),c.usermsg(c,a.packet.usermsg);if(a.packet.thumbnail)return m(a);if(a.packet.hangup)return c.hangup(!1);a.packet.sdp&&!c.received&&(c.received=!0,N(c)),a.packet.sdp?n(a):o(a)}}function m(a){var c=b(a.number);c.image.src=a.packet.thumbnail,c.thumb&&(c.imgset||c.thumb(c),c.imgset=!0)}function n(a){var c=b(a.number),e=c.pc,f="offer"==a.packet.type?"offer":"answer";f in c||(c[f]=!0,c.dialed=!0,d(c,"routing"),e.setRemoteDescription(new D(a.packet),function(){d(c,"connected"),"offer"==e.remoteDescription.type&&e.createAnswer(function(b){e.setLocalDescription(b,I,I),k(a.number,b,2)},I)},I))}function o(a){if(a.packet&&a.packet.candidate){var c=b(a.number),d=c.pc;d.addIceCandidate(new C(a.packet),I,I)}}var p=function(){},q=PUBNUB(a),r=a.publish_key||"demo",s=function(){return" "},t=a.subscribe_key||"demo",u=PUBNUB.uuid(),v=null,w=document.createElement("video"),x=!1,y=a.media||{audio:!0,video:!0},z={},A=null,B=window.RTCPeerConnection(A,{optional:[{RtpDataChannels:!0}]})||window.mozRTCPeerConnection(A,{optional:[{RtpDataChannels:!0}]})||window.webkitRTCPeerConnection(A,{optional:[{RtpDataChannels:!0}]}),C=window.mozRTCIceCandidate||window.RTCIceCandidate,D=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var E={iceServers:[{url:navigator.mozGetUserMedia?"stun:stun.services.mozilla.com":navigator.webkitGetUserMedia?"stun:stun.l.google.com:19302":"stun:23.21.150.121"},{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"},{url:"stun:23.21.150.121"},{url:"stun:stun01.sipphone.com"},{url:"stun:stun.ekiga.net"},{url:"stun:stun.fwdnet.net"},{url:"stun:stun.ideasip.com"},{url:"stun:stun.iptel.org"},{url:"stun:stun.rixtelecom.se"},{url:"stun:stun.schlund.de"},{url:"stun:stunserver.org"},{url:"stun:stun.softjoys.com"},{url:"stun:stun.voiparound.com"},{url:"stun:stun.voipbuster.com"},{url:"stun:stun.voipstunt.com"},{url:"stun:stun.voxgratia.org"},{url:"stun:stun.xten.com"}]};"servers"in a&&E.iceServers.unshift(a.servers);var F=function(){},G=function(){},H=function(){},I=function(){},J=function(){},K=function(){},L=function(){},M=function(){},N=function(){};return p.message=function(a){F=a},p.ready=function(a){G=a},p.unable=function(a){H=a},p.callstatus=function(a){M=a},p.debug=function(a){I=a},p.connect=function(a){J=a},p.disconnect=function(a){K=a},p.reconnect=function(a){L=a},p.receive=function(a){N=a},p.number=function(){return a.number},p.history=function(a){q.history({channel:a[number],callback:function(b){a.history(b[0])}})},p.dial=function(a){var c=b(a),d=c.pc;return c.dialed?!1:(c.dialed=!0,d.createOffer(function(b){k(a,{hangup:!0}),k(a,b,2),d.setLocalDescription(b,I,I)},I),c)},p.snap=function(a,c){if(c)return b(c).snap(a);var d={};return PUBNUB.each(z,function(a,b){d=b.snap()}),d},p.send=function(a,c){return c?b(c).send(a):void PUBNUB.each(z,function(b,c){c.send(a)})},p.hangup=function(a){return a?b(a).hangup():void PUBNUB.each(z,function(a,b){b.hangup()})},PUBNUB.bind("unload,beforeunload",window,function(){return p.goodbye?!0:(p.goodbye=!0,PUBNUB.each(z,function(b,c){var d=a.number,e={hangup:!0},f={packet:e,id:u,number:d},g=new XMLHttpRequest,h="http://pubsub.pubnub.com/publish/"+r+"/"+t+"/0/"+b+"/0/"+JSON.stringify(f);g.open("GET",h,!1),g.send(),c.hangup()}),!0)}),j(),p}}();